exports.id = 0;
exports.modules = {

/***/ "./src/backend/models/Image.js":
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("Object.defineProperty(exports, \"__esModule\", { value: true });var _mongoose = __webpack_require__(\"mongoose\");var _mongoose2 = _interopRequireDefault(_mongoose);\nvar _sharp = __webpack_require__(\"sharp\");var _sharp2 = _interopRequireDefault(_sharp);\nvar _path = __webpack_require__(\"path\");var _path2 = _interopRequireDefault(_path);\nvar _fs = __webpack_require__(\"fs\");var _fs2 = _interopRequireDefault(_fs);\nvar _util = __webpack_require__(\"./src/backend/common/util.js\");\nvar _db = __webpack_require__(\"./src/backend/common/db.js\");var _db2 = _interopRequireDefault(_db);\nvar _plugins = __webpack_require__(\"./src/backend/models/plugins/index.js\");\nvar _config = __webpack_require__(\"./src/backend/common/config.js\");function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}var\n\nSchema = _mongoose2.default.Schema;\n\nvar imageSchema = new Schema({\n  originalName: { type: String, required: true },\n  mimeType: { type: String, required: true, validate: _util.isImageFile },\n  fileName: { type: String, required: true } });\n\n\nimageSchema.plugin(_plugins.authorPlugin, {\n  insert: {\n    user: true },\n\n  get: {\n    guest: true },\n\n  remove: {\n    user: true } });\n\n\n\nvar getOriginalPath = function getOriginalPath(fileName) {return _path2.default.resolve(_config.imageUploadPaths.original, fileName);};\nvar getThumbnailPath = function getThumbnailPath(fileName, thumbnailSize) {return _path2.default.resolve(_config.imageUploadPaths.thumbnail, thumbnailSize.toString(), fileName);};\n\nimageSchema.statics.upload = function (file) {var\n  originalName = file.originalname,mimeType = file.mimetype,fileName = file.filename;\n  var originalPath = getOriginalPath(fileName);\n  var sharp = (0, _sharp2.default)(originalPath);\n  var promises = _config.thumbnailSizes.map(function (thumbnailSize) {\n    return new Promise(function (resolve, reject) {\n      var thumbnailPath = getThumbnailPath(fileName, thumbnailSize);\n      resolve(sharp.resize(thumbnailSize, thumbnailSize).max().withoutEnlargement().toFile(thumbnailPath));\n    });\n  });\n  return Promise.all(promises).\n  then(function () {return new Image({\n      originalName: originalName,\n      mimeType: mimeType,\n      fileName: fileName });});\n\n};\n\nimageSchema.statics.unlinkFiles = function (fileName) {\n  var originalPath = getOriginalPath(fileName);\n  var promises = _config.thumbnailSizes.map(function (thumbnailSize) {\n    var thumbnailPath = getThumbnailPath(fileName, thumbnailSize);\n    return (0, _util.deleteFile)(thumbnailPath);\n  });\n  return Promise.all(promises).\n  then((0, _util.deleteFile)(originalPath));\n};\n\nimageSchema.methods.read = function (thumbnailSize) {\n  var image = this;\n  return new Promise(function (resolve, reject) {\n    var path = thumbnailSize === null ?\n    getOriginalPath(image.fileName) :\n    getThumbnailPath(image.fileName, thumbnailSize);\n    _fs2.default.readFile(path, function (err, content) {\n      if (err) return reject(err);\n      resolve(content);\n    });\n  });\n};\n\nimageSchema.methods.unlinkFiles = function () {\n  return Image.unlinkFiles(this.fileName);\n};\n\nimageSchema.pre('remove', function (next) {\n  this.unlinkFiles().\n  then(function () {return next();}).\n  catch(next);\n});\n\nvar Image = _db2.default.model('Image', imageSchema);exports.default =\n\nImage;//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiLi9zcmMvYmFja2VuZC9tb2RlbHMvSW1hZ2UuanMuanMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvYmFja2VuZC9tb2RlbHMvSW1hZ2UuanM/YWFmNCJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO3ZhciBfbW9uZ29vc2UgPSByZXF1aXJlKCdtb25nb29zZScpO3ZhciBfbW9uZ29vc2UyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbW9uZ29vc2UpO1xudmFyIF9zaGFycCA9IHJlcXVpcmUoJ3NoYXJwJyk7dmFyIF9zaGFycDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zaGFycCk7XG52YXIgX3BhdGggPSByZXF1aXJlKCdwYXRoJyk7dmFyIF9wYXRoMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BhdGgpO1xudmFyIF9mcyA9IHJlcXVpcmUoJ2ZzJyk7dmFyIF9mczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9mcyk7XG52YXIgX3V0aWwgPSByZXF1aXJlKCcvY29tbW9uL3V0aWwnKTtcbnZhciBfZGIgPSByZXF1aXJlKCcvY29tbW9uL2RiJyk7dmFyIF9kYjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kYik7XG52YXIgX3BsdWdpbnMgPSByZXF1aXJlKCcvbW9kZWxzL3BsdWdpbnMnKTtcbnZhciBfY29uZmlnID0gcmVxdWlyZSgnL2NvbW1vbi9jb25maWcnKTtmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikge3JldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9O312YXJcblxuU2NoZW1hID0gX21vbmdvb3NlMi5kZWZhdWx0LlNjaGVtYTtcblxudmFyIGltYWdlU2NoZW1hID0gbmV3IFNjaGVtYSh7XG4gIG9yaWdpbmFsTmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gIG1pbWVUeXBlOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUsIHZhbGlkYXRlOiBfdXRpbC5pc0ltYWdlRmlsZSB9LFxuICBmaWxlTmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0gfSk7XG5cblxuaW1hZ2VTY2hlbWEucGx1Z2luKF9wbHVnaW5zLmF1dGhvclBsdWdpbiwge1xuICBpbnNlcnQ6IHtcbiAgICB1c2VyOiB0cnVlIH0sXG5cbiAgZ2V0OiB7XG4gICAgZ3Vlc3Q6IHRydWUgfSxcblxuICByZW1vdmU6IHtcbiAgICB1c2VyOiB0cnVlIH0gfSk7XG5cblxuXG52YXIgZ2V0T3JpZ2luYWxQYXRoID0gZnVuY3Rpb24gZ2V0T3JpZ2luYWxQYXRoKGZpbGVOYW1lKSB7cmV0dXJuIF9wYXRoMi5kZWZhdWx0LnJlc29sdmUoX2NvbmZpZy5pbWFnZVVwbG9hZFBhdGhzLm9yaWdpbmFsLCBmaWxlTmFtZSk7fTtcbnZhciBnZXRUaHVtYm5haWxQYXRoID0gZnVuY3Rpb24gZ2V0VGh1bWJuYWlsUGF0aChmaWxlTmFtZSwgdGh1bWJuYWlsU2l6ZSkge3JldHVybiBfcGF0aDIuZGVmYXVsdC5yZXNvbHZlKF9jb25maWcuaW1hZ2VVcGxvYWRQYXRocy50aHVtYm5haWwsIHRodW1ibmFpbFNpemUudG9TdHJpbmcoKSwgZmlsZU5hbWUpO307XG5cbmltYWdlU2NoZW1hLnN0YXRpY3MudXBsb2FkID0gZnVuY3Rpb24gKGZpbGUpIHt2YXJcbiAgb3JpZ2luYWxOYW1lID0gZmlsZS5vcmlnaW5hbG5hbWUsbWltZVR5cGUgPSBmaWxlLm1pbWV0eXBlLGZpbGVOYW1lID0gZmlsZS5maWxlbmFtZTtcbiAgdmFyIG9yaWdpbmFsUGF0aCA9IGdldE9yaWdpbmFsUGF0aChmaWxlTmFtZSk7XG4gIHZhciBzaGFycCA9ICgwLCBfc2hhcnAyLmRlZmF1bHQpKG9yaWdpbmFsUGF0aCk7XG4gIHZhciBwcm9taXNlcyA9IF9jb25maWcudGh1bWJuYWlsU2l6ZXMubWFwKGZ1bmN0aW9uICh0aHVtYm5haWxTaXplKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIHZhciB0aHVtYm5haWxQYXRoID0gZ2V0VGh1bWJuYWlsUGF0aChmaWxlTmFtZSwgdGh1bWJuYWlsU2l6ZSk7XG4gICAgICByZXNvbHZlKHNoYXJwLnJlc2l6ZSh0aHVtYm5haWxTaXplLCB0aHVtYm5haWxTaXplKS5tYXgoKS53aXRob3V0RW5sYXJnZW1lbnQoKS50b0ZpbGUodGh1bWJuYWlsUGF0aCkpO1xuICAgIH0pO1xuICB9KTtcbiAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKS5cbiAgdGhlbihmdW5jdGlvbiAoKSB7cmV0dXJuIG5ldyBJbWFnZSh7XG4gICAgICBvcmlnaW5hbE5hbWU6IG9yaWdpbmFsTmFtZSxcbiAgICAgIG1pbWVUeXBlOiBtaW1lVHlwZSxcbiAgICAgIGZpbGVOYW1lOiBmaWxlTmFtZSB9KTt9KTtcblxufTtcblxuaW1hZ2VTY2hlbWEuc3RhdGljcy51bmxpbmtGaWxlcyA9IGZ1bmN0aW9uIChmaWxlTmFtZSkge1xuICB2YXIgb3JpZ2luYWxQYXRoID0gZ2V0T3JpZ2luYWxQYXRoKGZpbGVOYW1lKTtcbiAgdmFyIHByb21pc2VzID0gX2NvbmZpZy50aHVtYm5haWxTaXplcy5tYXAoZnVuY3Rpb24gKHRodW1ibmFpbFNpemUpIHtcbiAgICB2YXIgdGh1bWJuYWlsUGF0aCA9IGdldFRodW1ibmFpbFBhdGgoZmlsZU5hbWUsIHRodW1ibmFpbFNpemUpO1xuICAgIHJldHVybiAoMCwgX3V0aWwuZGVsZXRlRmlsZSkodGh1bWJuYWlsUGF0aCk7XG4gIH0pO1xuICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpLlxuICB0aGVuKCgwLCBfdXRpbC5kZWxldGVGaWxlKShvcmlnaW5hbFBhdGgpKTtcbn07XG5cbmltYWdlU2NoZW1hLm1ldGhvZHMucmVhZCA9IGZ1bmN0aW9uICh0aHVtYm5haWxTaXplKSB7XG4gIHZhciBpbWFnZSA9IHRoaXM7XG4gIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgdmFyIHBhdGggPSB0aHVtYm5haWxTaXplID09PSBudWxsID9cbiAgICBnZXRPcmlnaW5hbFBhdGgoaW1hZ2UuZmlsZU5hbWUpIDpcbiAgICBnZXRUaHVtYm5haWxQYXRoKGltYWdlLmZpbGVOYW1lLCB0aHVtYm5haWxTaXplKTtcbiAgICBfZnMyLmRlZmF1bHQucmVhZEZpbGUocGF0aCwgZnVuY3Rpb24gKGVyciwgY29udGVudCkge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgcmVzb2x2ZShjb250ZW50KTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5pbWFnZVNjaGVtYS5tZXRob2RzLnVubGlua0ZpbGVzID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gSW1hZ2UudW5saW5rRmlsZXModGhpcy5maWxlTmFtZSk7XG59O1xuXG5pbWFnZVNjaGVtYS5wcmUoJ3JlbW92ZScsIGZ1bmN0aW9uIChuZXh0KSB7XG4gIHRoaXMudW5saW5rRmlsZXMoKS5cbiAgdGhlbihmdW5jdGlvbiAoKSB7cmV0dXJuIG5leHQoKTt9KS5cbiAgY2F0Y2gobmV4dCk7XG59KTtcblxudmFyIEltYWdlID0gX2RiMi5kZWZhdWx0Lm1vZGVsKCdJbWFnZScsIGltYWdlU2NoZW1hKTtleHBvcnRzLmRlZmF1bHQgPVxuXG5JbWFnZTtcblxuXG4vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFdFQlBBQ0sgRk9PVEVSXG4vLyAuL3NyYy9iYWNrZW5kL21vZGVscy9JbWFnZS5qc1xuLy8gbW9kdWxlIGlkID0gLi9zcmMvYmFja2VuZC9tb2RlbHMvSW1hZ2UuanNcbi8vIG1vZHVsZSBjaHVua3MgPSAwIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///./src/backend/models/Image.js\n");

/***/ })

};