exports.id = 0;
exports.modules = {

/***/ "./src/backend/models/Image.js":
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("Object.defineProperty(exports, \"__esModule\", { value: true });var _mongoose = __webpack_require__(\"mongoose\");var _mongoose2 = _interopRequireDefault(_mongoose);\nvar _sharp = __webpack_require__(\"sharp\");var _sharp2 = _interopRequireDefault(_sharp);\nvar _path = __webpack_require__(\"path\");var _path2 = _interopRequireDefault(_path);\nvar _fs = __webpack_require__(\"fs\");var _fs2 = _interopRequireDefault(_fs);\nvar _util = __webpack_require__(\"./src/backend/common/util.js\");\nvar _db = __webpack_require__(\"./src/backend/common/db.js\");var _db2 = _interopRequireDefault(_db);\nvar _plugins = __webpack_require__(\"./src/backend/models/plugins/index.js\");\nvar _config = __webpack_require__(\"./src/backend/common/config.js\");function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}var\n\nSchema = _mongoose2.default.Schema;\n\nvar imageSchema = new Schema({\n  originalName: { type: String, required: true },\n  mimeType: { type: String, required: true, validate: _util.isImageFile },\n  fileName: { type: String, required: true } });\n\n\nimageSchema.plugin(_plugins.authorPlugin, {\n  insert: {\n    guest: true },\n\n  get: {\n    guest: true },\n\n  remove: {\n    guest: true } });\n\n\n\nvar getOriginalPath = function getOriginalPath(fileName) {return _path2.default.resolve(_config.imageUploadPaths.original, fileName);};\nvar getThumbnailPath = function getThumbnailPath(fileName, thumbnailSize) {return _path2.default.resolve(_config.imageUploadPaths.thumbnail, thumbnailSize.toString(), fileName);};\n\nimageSchema.statics.upload = function (file) {var\n  originalName = file.originalname,mimeType = file.mimetype,fileName = file.filename;\n  var originalPath = getOriginalPath(fileName);\n  var sharp = (0, _sharp2.default)(originalPath);\n  var promises = _config.thumbnailSizes.map(function (thumbnailSize) {\n    return new Promise(function (resolve, reject) {\n      var thumbnailPath = getThumbnailPath(fileName, thumbnailSize);\n      resolve(sharp.resize(thumbnailSize, thumbnailSize).max().withoutEnlargement().toFile(thumbnailPath));\n    });\n  });\n  return Promise.all(promises).\n  then(function () {return new Image({\n      originalName: originalName,\n      mimeType: mimeType,\n      fileName: fileName });});\n\n};\n\nimageSchema.statics.unlinkFiles = function (fileName) {\n  var originalPath = getOriginalPath(fileName);\n  var promises = _config.thumbnailSizes.map(function (thumbnailSize) {\n    var thumbnailPath = getThumbnailPath(fileName, thumbnailSize);\n    return (0, _util.deleteFile)(thumbnailPath);\n  });\n  return Promise.all(promises).\n  then((0, _util.deleteFile)(originalPath));\n};\n\nimageSchema.methods.read = function (thumbnailSize) {\n  var image = this;\n  return new Promise(function (resolve, reject) {\n    var path = thumbnailSize === null ?\n    getOriginalPath(image.fileName) :\n    getThumbnailPath(image.fileName, thumbnailSize);\n    _fs2.default.readFile(path, function (err, content) {\n      if (err) return reject(err);\n      resolve(content);\n    });\n  });\n};\n\nimageSchema.methods.unlinkFiles = function () {\n  return Image.unlinkFiles(this.fileName);\n};\n\nimageSchema.pre('remove', function (next) {\n  this.unlinkFiles().\n  then(function () {return next();}).\n  catch(next);\n});\n\nvar Image = _db2.default.model('Image', imageSchema);exports.default =\n\nImage;//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiLi9zcmMvYmFja2VuZC9tb2RlbHMvSW1hZ2UuanMuanMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvYmFja2VuZC9tb2RlbHMvSW1hZ2UuanM/YWFmNCJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO3ZhciBfbW9uZ29vc2UgPSByZXF1aXJlKCdtb25nb29zZScpO3ZhciBfbW9uZ29vc2UyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbW9uZ29vc2UpO1xudmFyIF9zaGFycCA9IHJlcXVpcmUoJ3NoYXJwJyk7dmFyIF9zaGFycDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9zaGFycCk7XG52YXIgX3BhdGggPSByZXF1aXJlKCdwYXRoJyk7dmFyIF9wYXRoMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BhdGgpO1xudmFyIF9mcyA9IHJlcXVpcmUoJ2ZzJyk7dmFyIF9mczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9mcyk7XG52YXIgX3V0aWwgPSByZXF1aXJlKCcvY29tbW9uL3V0aWwnKTtcbnZhciBfZGIgPSByZXF1aXJlKCcvY29tbW9uL2RiJyk7dmFyIF9kYjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kYik7XG52YXIgX3BsdWdpbnMgPSByZXF1aXJlKCcvbW9kZWxzL3BsdWdpbnMnKTtcbnZhciBfY29uZmlnID0gcmVxdWlyZSgnL2NvbW1vbi9jb25maWcnKTtmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikge3JldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9O312YXJcblxuU2NoZW1hID0gX21vbmdvb3NlMi5kZWZhdWx0LlNjaGVtYTtcblxudmFyIGltYWdlU2NoZW1hID0gbmV3IFNjaGVtYSh7XG4gIG9yaWdpbmFsTmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0sXG4gIG1pbWVUeXBlOiB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IHRydWUsIHZhbGlkYXRlOiBfdXRpbC5pc0ltYWdlRmlsZSB9LFxuICBmaWxlTmFtZTogeyB0eXBlOiBTdHJpbmcsIHJlcXVpcmVkOiB0cnVlIH0gfSk7XG5cblxuaW1hZ2VTY2hlbWEucGx1Z2luKF9wbHVnaW5zLmF1dGhvclBsdWdpbiwge1xuICBpbnNlcnQ6IHtcbiAgICBndWVzdDogdHJ1ZSB9LFxuXG4gIGdldDoge1xuICAgIGd1ZXN0OiB0cnVlIH0sXG5cbiAgcmVtb3ZlOiB7XG4gICAgZ3Vlc3Q6IHRydWUgfSB9KTtcblxuXG5cbnZhciBnZXRPcmlnaW5hbFBhdGggPSBmdW5jdGlvbiBnZXRPcmlnaW5hbFBhdGgoZmlsZU5hbWUpIHtyZXR1cm4gX3BhdGgyLmRlZmF1bHQucmVzb2x2ZShfY29uZmlnLmltYWdlVXBsb2FkUGF0aHMub3JpZ2luYWwsIGZpbGVOYW1lKTt9O1xudmFyIGdldFRodW1ibmFpbFBhdGggPSBmdW5jdGlvbiBnZXRUaHVtYm5haWxQYXRoKGZpbGVOYW1lLCB0aHVtYm5haWxTaXplKSB7cmV0dXJuIF9wYXRoMi5kZWZhdWx0LnJlc29sdmUoX2NvbmZpZy5pbWFnZVVwbG9hZFBhdGhzLnRodW1ibmFpbCwgdGh1bWJuYWlsU2l6ZS50b1N0cmluZygpLCBmaWxlTmFtZSk7fTtcblxuaW1hZ2VTY2hlbWEuc3RhdGljcy51cGxvYWQgPSBmdW5jdGlvbiAoZmlsZSkge3ZhclxuICBvcmlnaW5hbE5hbWUgPSBmaWxlLm9yaWdpbmFsbmFtZSxtaW1lVHlwZSA9IGZpbGUubWltZXR5cGUsZmlsZU5hbWUgPSBmaWxlLmZpbGVuYW1lO1xuICB2YXIgb3JpZ2luYWxQYXRoID0gZ2V0T3JpZ2luYWxQYXRoKGZpbGVOYW1lKTtcbiAgdmFyIHNoYXJwID0gKDAsIF9zaGFycDIuZGVmYXVsdCkob3JpZ2luYWxQYXRoKTtcbiAgdmFyIHByb21pc2VzID0gX2NvbmZpZy50aHVtYm5haWxTaXplcy5tYXAoZnVuY3Rpb24gKHRodW1ibmFpbFNpemUpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgdmFyIHRodW1ibmFpbFBhdGggPSBnZXRUaHVtYm5haWxQYXRoKGZpbGVOYW1lLCB0aHVtYm5haWxTaXplKTtcbiAgICAgIHJlc29sdmUoc2hhcnAucmVzaXplKHRodW1ibmFpbFNpemUsIHRodW1ibmFpbFNpemUpLm1heCgpLndpdGhvdXRFbmxhcmdlbWVudCgpLnRvRmlsZSh0aHVtYm5haWxQYXRoKSk7XG4gICAgfSk7XG4gIH0pO1xuICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpLlxuICB0aGVuKGZ1bmN0aW9uICgpIHtyZXR1cm4gbmV3IEltYWdlKHtcbiAgICAgIG9yaWdpbmFsTmFtZTogb3JpZ2luYWxOYW1lLFxuICAgICAgbWltZVR5cGU6IG1pbWVUeXBlLFxuICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lIH0pO30pO1xuXG59O1xuXG5pbWFnZVNjaGVtYS5zdGF0aWNzLnVubGlua0ZpbGVzID0gZnVuY3Rpb24gKGZpbGVOYW1lKSB7XG4gIHZhciBvcmlnaW5hbFBhdGggPSBnZXRPcmlnaW5hbFBhdGgoZmlsZU5hbWUpO1xuICB2YXIgcHJvbWlzZXMgPSBfY29uZmlnLnRodW1ibmFpbFNpemVzLm1hcChmdW5jdGlvbiAodGh1bWJuYWlsU2l6ZSkge1xuICAgIHZhciB0aHVtYm5haWxQYXRoID0gZ2V0VGh1bWJuYWlsUGF0aChmaWxlTmFtZSwgdGh1bWJuYWlsU2l6ZSk7XG4gICAgcmV0dXJuICgwLCBfdXRpbC5kZWxldGVGaWxlKSh0aHVtYm5haWxQYXRoKTtcbiAgfSk7XG4gIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykuXG4gIHRoZW4oKDAsIF91dGlsLmRlbGV0ZUZpbGUpKG9yaWdpbmFsUGF0aCkpO1xufTtcblxuaW1hZ2VTY2hlbWEubWV0aG9kcy5yZWFkID0gZnVuY3Rpb24gKHRodW1ibmFpbFNpemUpIHtcbiAgdmFyIGltYWdlID0gdGhpcztcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICB2YXIgcGF0aCA9IHRodW1ibmFpbFNpemUgPT09IG51bGwgP1xuICAgIGdldE9yaWdpbmFsUGF0aChpbWFnZS5maWxlTmFtZSkgOlxuICAgIGdldFRodW1ibmFpbFBhdGgoaW1hZ2UuZmlsZU5hbWUsIHRodW1ibmFpbFNpemUpO1xuICAgIF9mczIuZGVmYXVsdC5yZWFkRmlsZShwYXRoLCBmdW5jdGlvbiAoZXJyLCBjb250ZW50KSB7XG4gICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKGNvbnRlbnQpO1xuICAgIH0pO1xuICB9KTtcbn07XG5cbmltYWdlU2NoZW1hLm1ldGhvZHMudW5saW5rRmlsZXMgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBJbWFnZS51bmxpbmtGaWxlcyh0aGlzLmZpbGVOYW1lKTtcbn07XG5cbmltYWdlU2NoZW1hLnByZSgncmVtb3ZlJywgZnVuY3Rpb24gKG5leHQpIHtcbiAgdGhpcy51bmxpbmtGaWxlcygpLlxuICB0aGVuKGZ1bmN0aW9uICgpIHtyZXR1cm4gbmV4dCgpO30pLlxuICBjYXRjaChuZXh0KTtcbn0pO1xuXG52YXIgSW1hZ2UgPSBfZGIyLmRlZmF1bHQubW9kZWwoJ0ltYWdlJywgaW1hZ2VTY2hlbWEpO2V4cG9ydHMuZGVmYXVsdCA9XG5cbkltYWdlO1xuXG5cbi8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gV0VCUEFDSyBGT09URVJcbi8vIC4vc3JjL2JhY2tlbmQvbW9kZWxzL0ltYWdlLmpzXG4vLyBtb2R1bGUgaWQgPSAuL3NyYy9iYWNrZW5kL21vZGVscy9JbWFnZS5qc1xuLy8gbW9kdWxlIGNodW5rcyA9IDAiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///./src/backend/models/Image.js\n");

/***/ })

};